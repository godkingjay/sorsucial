import { apiConfig } from "@/lib/api/apiConfig";
import { SiteUserAPI } from "@/lib/interfaces/api";
import { SiteUser } from "@/lib/interfaces/user";
import clientPromise from "@/lib/mongodb";
import { ObjectId } from "mongodb";
import { NextApiRequest, NextApiResponse } from "next";

/**------------------------------------------------------------------------------------------
 *
 * ~ ██╗   ██╗███████╗███████╗██████╗     ███████╗███╗   ██╗██████╗ ██████╗  ██████╗ ██╗███╗   ██╗████████╗
 * ~ ██║   ██║██╔════╝██╔════╝██╔══██╗    ██╔════╝████╗  ██║██╔══██╗██╔══██╗██╔═══██╗██║████╗  ██║╚══██╔══╝
 * ~ ██║   ██║███████╗█████╗  ██████╔╝    █████╗  ██╔██╗ ██║██║  ██║██████╔╝██║   ██║██║██╔██╗ ██║   ██║
 * ~ ██║   ██║╚════██║██╔══╝  ██╔══██╗    ██╔══╝  ██║╚██╗██║██║  ██║██╔═══╝ ██║   ██║██║██║╚██╗██║   ██║
 * ~ ╚██████╔╝███████║███████╗██║  ██║    ███████╗██║ ╚████║██████╔╝██║     ╚██████╔╝██║██║ ╚████║   ██║
 * ~  ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝    ╚══════╝╚═╝  ╚═══╝╚═════╝ ╚═╝      ╚═════╝ ╚═╝╚═╝  ╚═══╝   ╚═╝
 *
 * ------------------------------------------------------------------------------------------
 *
 *
 *
 * ------------------------------------------------------------------------------------------
 */
/**
 *
 * @param {NextApiRequest} req
 * @param {NextApiResponse} res
 *
 */
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
	try {
		const client = await clientPromise;
		const db = client.db("sorsu-db");
		const usersCollection = db.collection("users");
		const apiCollection = db.collection("api");
		const { privateKey } = req.body || req.query;

		switch (req.method) {
			/**------------------------------------------------------------------------------------------
			 *
			 * *  ██████╗██████╗ ███████╗ █████╗ ████████╗███████╗    ██╗   ██╗███████╗███████╗██████╗
			 * * ██╔════╝██╔══██╗██╔════╝██╔══██╗╚══██╔══╝██╔════╝    ██║   ██║██╔════╝██╔════╝██╔══██╗
			 * * ██║     ██████╔╝█████╗  ███████║   ██║   █████╗      ██║   ██║███████╗█████╗  ██████╔╝
			 * * ██║     ██╔══██╗██╔══╝  ██╔══██║   ██║   ██╔══╝      ██║   ██║╚════██║██╔══╝  ██╔══██╗
			 * * ╚██████╗██║  ██║███████╗██║  ██║   ██║   ███████╗    ╚██████╔╝███████║███████╗██║  ██║
			 * *  ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝     ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝
			 *
			 * ------------------------------------------------------------------------------------------
			 *
			 *
			 *
			 * ------------------------------------------------------------------------------------------
			 */
			case "POST": {
				const { newUser }: { newUser: SiteUser } = req.body;

				if (!newUser) {
					res.status(500).json({ error: "No user provided" });
					return;
				}

				const newUserState = await usersCollection.insertOne(newUser);

				const newAPIDate = new Date();

				const apiId = new ObjectId();

				const newUserAPIKey: Partial<SiteUserAPI> = {
					userId: newUser.uid,
					keys: [
						{
							id: apiId.toHexString(),
							key: new ObjectId().toHexString(),
							keyType: "default",
							name: "User API",
							description: "",
							updatedAt: newAPIDate,
							createdAt: newAPIDate,
						},
					],
					updatedAt: newAPIDate,
					createdAt: newAPIDate,
				};

				const newUserAPIState = await apiCollection.insertOne(newUserAPIKey);

				res.status(200).json({ newUserState, newUser });
				break;
			}

			/**------------------------------------------------------------------------------------------
			 *
			 * ^  ██████╗ ███████╗████████╗    ██╗   ██╗███████╗███████╗██████╗
			 * ^ ██╔════╝ ██╔════╝╚══██╔══╝    ██║   ██║██╔════╝██╔════╝██╔══██╗
			 * ^ ██║  ███╗█████╗     ██║       ██║   ██║███████╗█████╗  ██████╔╝
			 * ^ ██║   ██║██╔══╝     ██║       ██║   ██║╚════██║██╔══╝  ██╔══██╗
			 * ^ ╚██████╔╝███████╗   ██║       ╚██████╔╝███████║███████╗██║  ██║
			 * ^  ╚═════╝ ╚══════╝   ╚═╝        ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝
			 *
			 * ------------------------------------------------------------------------------------------
			 *
			 *
			 *
			 * ------------------------------------------------------------------------------------------
			 */
			case "GET": {
				const { getUserId } = req.query;

				if (!privateKey || privateKey !== apiConfig.privateKey) {
					res.status(401).json({ message: "Unauthorized" });
					return;
				}

				if (!getUserId) {
					res.status(500).json({ error: "No user id provided" });
					return;
				}

				const userData = await usersCollection.findOne({
					uid: getUserId,
				});

				const userAPI = await apiCollection.findOne({
					userId: getUserId,
				});

				res.status(200).json({ userData, userAPI });
				break;
			}

			/**------------------------------------------------------------------------------------------
			 *
			 * ? ███████╗██████╗ ██╗████████╗    ██╗   ██╗███████╗███████╗██████╗
			 * ? ██╔════╝██╔══██╗██║╚══██╔══╝    ██║   ██║██╔════╝██╔════╝██╔══██╗
			 * ? █████╗  ██║  ██║██║   ██║       ██║   ██║███████╗█████╗  ██████╔╝
			 * ? ██╔══╝  ██║  ██║██║   ██║       ██║   ██║╚════██║██╔══╝  ██╔══██╗
			 * ? ███████╗██████╔╝██║   ██║       ╚██████╔╝███████║███████╗██║  ██║
			 * ? ╚══════╝╚═════╝ ╚═╝   ╚═╝        ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝
			 *
			 * ------------------------------------------------------------------------------------------
			 *
			 *
			 *
			 * ------------------------------------------------------------------------------------------
			 */
			case "PUT": {
				const { updatedUserData, updateUserId } = req.body;

				if (!updatedUserData || !updateUserId) {
					res.status(500).json({ error: "No user data provided" });
					return;
				}

				const updatedUserState = await usersCollection.updateOne(
					{ uid: updateUserId },
					{ $set: updatedUserData }
				);

				res
					.status(200)
					.json({ newUserState: updatedUserState, newUser: updatedUserData });
				break;
			}

			/**------------------------------------------------------------------------------------------
			 *
			 * ! ██████╗ ███████╗██╗     ███████╗████████╗███████╗    ██╗   ██╗███████╗███████╗██████╗
			 * ! ██╔══██╗██╔════╝██║     ██╔════╝╚══██╔══╝██╔════╝    ██║   ██║██╔════╝██╔════╝██╔══██╗
			 * ! ██║  ██║█████╗  ██║     █████╗     ██║   █████╗      ██║   ██║███████╗█████╗  ██████╔╝
			 * ! ██║  ██║██╔══╝  ██║     ██╔══╝     ██║   ██╔══╝      ██║   ██║╚════██║██╔══╝  ██╔══██╗
			 * ! ██████╔╝███████╗███████╗███████╗   ██║   ███████╗    ╚██████╔╝███████║███████╗██║  ██║
			 * ! ╚═════╝ ╚══════╝╚══════╝╚══════╝   ╚═╝   ╚══════╝     ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝
			 *
			 * ------------------------------------------------------------------------------------------
			 *
			 *
			 *
			 * ------------------------------------------------------------------------------------------
			 */
			case "DELETE": {
				const { userId } = req.body;

				if (!userId) {
					res.status(500).json({ error: "No user id provided" });
					return;
				}

				const deleteState = await usersCollection.deleteOne({
					uid: userId,
				});

				res.status(200).json({ deleteState });
				break;
			}

			/**-------------------------------------------------------------------------------------------
			 *
			 * & ██████╗ ███████╗███████╗ █████╗ ██╗   ██╗██╗  ████████╗
			 * & ██╔══██╗██╔════╝██╔════╝██╔══██╗██║   ██║██║  ╚══██╔══╝
			 * & ██║  ██║█████╗  █████╗  ███████║██║   ██║██║     ██║
			 * & ██║  ██║██╔══╝  ██╔══╝  ██╔══██║██║   ██║██║     ██║
			 * & ██████╔╝███████╗██║     ██║  ██║╚██████╔╝███████╗██║
			 * & ╚═════╝ ╚══════╝╚═╝     ╚═╝  ╚═╝ ╚═════╝ ╚══════╝╚═╝
			 *
			 * -------------------------------------------------------------------------------------------
			 *
			 *
			 *
			 * -------------------------------------------------------------------------------------------
			 */
			default: {
				res.status(500).json({ error: "Invalid request method" });
				break;
			}
		}
	} catch (error: any) {
		res.status(500).json({ error: error.message });
	}
}
